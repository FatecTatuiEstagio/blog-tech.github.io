{% assign audio_date = include.audio_date | default: page.public_id %}
{% assign audio_data = site.data.cloudinary-urls[audio_date] %}

{%- comment -%}
Render the audio player. If the build-time `site.data` has the URL, include it in `data-audio-url`.
Otherwise include `data-audio-key` and client-side JS will call the audio API to resolve the URL at runtime.
{%- endcomment -%}

{% if audio_data %}
  <div
    class="bg-[#102564] text-white rounded-lg p-4 my-6 audio-player"
    data-audio-url="{{ audio_data.url }}"
    data-title="{{ include.title }}">
{% else %}
  <div
    class="bg-[#102564] text-white rounded-lg p-4 my-6 audio-player"
    data-audio-key="{{ audio_date }}"
    data-title="{{ include.title }}"
    data-audio-url="">
{% endif %}
    <audio></audio>

    <div class="text-tech-white mb-3">
      <h3 class="text-lg font-semibold">Ouça esta entrevista</h3>
    </div>

    <div class="flex items-center space-x-3">
      <button type="button" class="play-btn bg-tech-light-blue hover:bg-tech-light-blue/80 text-tech-white rounded-full w-10 h-10 flex items-center justify-center transition-colors">
        ▶
      </button>

      <div class="flex-1 space-y-2">
        <input
          type="range"
          class="seek-range w-full h-2 rounded-full appearance-none bg-tech-white/20 cursor-pointer"
          min="0"
          max="0"
          value="0" />
        <div class="flex justify-between text-xs text-tech-white/70">
          <span class="current-time">00:00</span>
          <span class="duration">00:00</span>
        </div>
      </div>

      <div class="flex items-center space-x-2">
        <button type="button" class="mute-btn text-tech-white hover:text-tech-light-blue transition-colors">🔊</button>
        <input
          type="range"
          class="volume-range w-20 h-1 rounded-full appearance-none bg-tech-white/20 cursor-pointer"
          min="0"
          max="1"
          step="0.01"
          value="1" />
      </div>
    </div>
  </div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".audio-player").forEach(async player => {
    // If there's no data-audio-url but a data-audio-key exists, fetch URL from API
    const key = player.dataset.audioKey;
    if (!player.dataset.audioUrl && key) {
      try {
        const base = window.__AUDIO_API_BASE__ || 'https://blog-server-0y0k.onrender.com';
        const res = await fetch(`${base}/audio/${encodeURIComponent(key)}`);
        if (res.ok) {
          const json = await res.json();
          player.dataset.audioUrl = json.url;
        } else {
          // audio not found; hide player
          player.style.display = 'none';
          return;
        }
      } catch (err) {
        console.error('Failed to fetch audio url for', key, err);
        player.style.display = 'none';
        return;
      }
    }

    const audio = player.querySelector("audio");
    const playBtn = player.querySelector(".play-btn");
    const muteBtn = player.querySelector(".mute-btn");
    const seekRange = player.querySelector(".seek-range");
    const volumeRange = player.querySelector(".volume-range");
    const currentTimeEl = player.querySelector(".current-time");
    const durationEl = player.querySelector(".duration");
  
    audio.src = player.dataset.audioUrl;
  
    // Format time MM:SS
    function formatTime(time) {
      if (isNaN(time)) return "00:00";
      const m = Math.floor(time / 60);
      const s = Math.floor(time % 60);
      return `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
    }
  
    // Play/pause toggle
    playBtn.addEventListener("click", () => {
      if (audio.paused) {
        audio.play();
        playBtn.textContent = "⏸";
      } else {
        audio.pause();
        playBtn.textContent = "▶";
      }
    });
  
    // Update seek bar
    audio.addEventListener("timeupdate", () => {
      seekRange.value = audio.currentTime;
      seekRange.style.background = `linear-gradient(to right, #71c3ec ${(audio.currentTime / (audio.duration || 1)) * 100}%, rgba(255,255,255,0.2) ${(audio.currentTime / (audio.duration || 1)) * 100}%)`;
      currentTimeEl.textContent = formatTime(audio.currentTime);
    });
  
    // Loaded metadata
    audio.addEventListener("loadedmetadata", () => {
      seekRange.max = audio.duration;
      durationEl.textContent = formatTime(audio.duration);
    });
  
    // Seek control
    seekRange.addEventListener("input", e => {
      audio.currentTime = e.target.value;
    });
  
    // Volume control
    volumeRange.addEventListener("input", e => {
      audio.volume = e.target.value;
      muteBtn.textContent = audio.volume == 0 ? "🔇" : "🔊";
      volumeRange.style.background = `linear-gradient(to right, #71c3ec ${audio.volume * 100}%, rgba(255,255,255,0.2) ${audio.volume * 100}%)`;
    });
  
    // Mute toggle
    muteBtn.addEventListener("click", () => {
      audio.muted = !audio.muted;
      muteBtn.textContent = audio.muted ? "🔇" : "🔊";
    });
  
    // Reset when ended
    audio.addEventListener("ended", () => {
      playBtn.textContent = "▶";
    });
  });
  });
</script>